{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Stencila Config",
  "description": "Configuration for Stencila workspaces",
  "type": "object",
  "properties": {
    "workspace": {
      "description": "Workspace configuration\n\nWorkspaces are the primary entity in Stencila Cloud, representing a\nGitHub repository. Sites and watches are scoped under workspaces.",
      "anyOf": [
        {
          "$ref": "#/definitions/WorkspaceConfig"
        },
        {
          "type": "null"
        }
      ]
    },
    "site": {
      "description": "Site configuration\nhttps://stencila.io/docs/config/site",
      "anyOf": [
        {
          "$ref": "#/definitions/SiteConfig"
        },
        {
          "type": "null"
        }
      ]
    },
    "remotes": {
      "description": "Remote synchronization configuration\nhttps://stencila.io/docs/config/remotes",
      "type": [
        "object",
        "null"
      ],
      "additionalProperties": {
        "$ref": "#/definitions/RemoteValue"
      }
    },
    "outputs": {
      "description": "Outputs configuration\n\nDefines files to be rendered/converted and uploaded to Stencila Cloud\nworkspace outputs. The key is the output path template, and the value can be:\n- A simple source path: `\"report.pdf\" = \"report.md\"`\n- A configuration object: `\"report.pdf\" = { source = \"report.md\", command = \"render\" }`\n- A static file: `\"data.csv\" = {}` (copies file as-is)\n- A pattern: `\"exports/*.csv\" = { pattern = \"exports/*.csv\" }`\n- A spread: `\"{region}/report.pdf\" = { source = \"report.md\", arguments = { region = [\"north\", \"south\"] } }`\n\nExample:\n```toml\n[outputs]\n\"report.pdf\" = \"report.md\"\n\"data/results.csv\" = {}\n\"{region}/report.pdf\" = { source = \"report.md\", arguments = { region = [\"north\", \"south\"] } }\n```",
      "type": [
        "object",
        "null"
      ],
      "additionalProperties": {
        "$ref": "#/definitions/OutputTarget"
      }
    }
  },
  "definitions": {
    "WorkspaceConfig": {
      "description": "Configuration for a Stencila Cloud workspace\n\nWorkspaces are the primary entity in Stencila Cloud, representing a\nGitHub repository. Sites and watches are scoped under workspaces.\n\nExample:\n```toml\n[workspace]\nid = \"ws3x9k2m7fab\"\n```",
      "type": "object",
      "properties": {
        "id": {
          "description": "The workspace public ID from Stencila Cloud\n\nThis is automatically assigned when a workspace is created via\n`stencila site create` or when pushing to a site for the first time.\nThe workspace ID is derived from the GitHub repository URL.",
          "type": [
            "string",
            "null"
          ],
          "pattern": "^ws[a-z0-9]{10}$"
        }
      }
    },
    "SiteConfig": {
      "description": "Configuration for a site\nhttps://stencila.io/docs/config/site",
      "type": "object",
      "properties": {
        "domain": {
          "description": "Custom domain for the site\n\nThis is a cached value that is kept in sync with Stencila Cloud\nwhen site details are fetched or the domain is modified.\nThe canonical source is the Stencila Cloud API.",
          "type": [
            "string",
            "null"
          ],
          "pattern": "^([a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?\\.)+[a-z]{2,}$"
        },
        "root": {
          "description": "Root directory for site content\n\nPath relative to the config file containing this setting.\nWhen set, only files within this directory will be published\nto the site, and routes will be calculated relative to this\ndirectory rather than the workspace root.\n\nExample: If set to \"docs\" in /myproject/stencila.toml,\nthen /myproject/docs/guide.md â†’ /guide/ (not /docs/guide/)",
          "anyOf": [
            {
              "$ref": "#/definitions/ConfigRelativePath"
            },
            {
              "type": "null"
            }
          ]
        },
        "exclude": {
          "description": "Glob patterns for files to exclude when publishing\n\nFiles matching these patterns will be excluded from publishing.\nExclude patterns take precedence over include patterns.\nPatterns are relative to `root` (if set) or the workspace root.\nDefault exclusions (`.git/`, `node_modules/`, etc.) are applied automatically.\n\nExample: `[\"**/*.draft.md\", \"temp/**\"]`",
          "type": [
            "array",
            "null"
          ],
          "items": {
            "type": "string"
          }
        },
        "routes": {
          "description": "Custom routes for serving content\n\nRoutes map URL paths to files, redirects, or spread configurations.\nThe key is the URL path (or path template for spreads), and the value can be:\n- A simple string for the file path: `\"/about/\" = \"README.md\"`\n- An object for redirects: `\"/old/\" = { redirect = \"/new/\", status = 301 }`\n- An object for spreads: `\"/{region}/\" = { file = \"report.smd\", arguments = { region = [\"north\", \"south\"] } }`\n\nExample:\n```toml\n[site.routes]\n\"/\" = \"index.md\"\n\"/about/\" = \"README.md\"\n\"/old-page/\" = { redirect = \"/new-page/\", status = 301 }\n\"/{region}/{species}/\" = { file = \"report.smd\", arguments = { region = [\"north\", \"south\"], species = [\"ABC\", \"DEF\"] } }\n```",
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": {
            "$ref": "#/definitions/RouteTarget"
          }
        }
      }
    },
    "ConfigRelativePath": {
      "description": "A path that is resolved relative to the configuration file it was defined in\n\nThis wrapper provides JsonSchema implementation and stores paths as strings.\nThe paths will be resolved relative to the config file directory during use.",
      "type": "string"
    },
    "RouteTarget": {
      "description": "Target for a route - either a file path, a redirect, or a spread\nhttps://stencila.io/docs/config/site#routes",
      "anyOf": [
        {
          "description": "Serve a file at this path\n\nPath relative to the workspace directory (or `site.root` if configured).\n\nExample in TOML:\n```toml\n[site.routes]\n\"/about/\" = \"README.md\"\n```",
          "allOf": [
            {
              "$ref": "#/definitions/ConfigRelativePath"
            }
          ]
        },
        {
          "description": "Redirect to another URL\n\nExample in TOML:\n```toml\n[site.routes]\n\"/old/\" = { redirect = \"/new/\", status = 301 }\n```",
          "allOf": [
            {
              "$ref": "#/definitions/RouteRedirect"
            }
          ]
        },
        {
          "description": "Spread configuration for multi-variant routes\n\nExample in TOML:\n```toml\n[site.routes]\n\"/{region}/{species}/\" = { file = \"report.smd\", arguments = { region = [\"north\", \"south\"], species = [\"A\", \"B\"] } }\n```",
          "allOf": [
            {
              "$ref": "#/definitions/RouteSpread"
            }
          ]
        }
      ]
    },
    "RouteRedirect": {
      "description": "A redirect configuration\nhttps://stencila.io/docs/config/site#routes-redirect",
      "type": "object",
      "properties": {
        "redirect": {
          "description": "The URL to redirect to\n\nCan be an absolute URL or a relative path.\n\nExamples:\n- /new-location/ - Redirect to another path on the same site\n- https://example.com - Redirect to an external URL",
          "type": "string"
        },
        "status": {
          "description": "HTTP status code for the redirect\n\nDetermines the type of redirect. Common values:\n- 301 - Moved Permanently (permanent redirect)\n- 302 - Found (temporary redirect, default)\n- 303 - See Other\n- 307 - Temporary Redirect\n- 308 - Permanent Redirect\n\nIf not specified, defaults to 302 (temporary redirect).",
          "anyOf": [
            {
              "$ref": "#/definitions/RedirectStatus"
            },
            {
              "type": "null"
            }
          ]
        }
      },
      "required": [
        "redirect"
      ]
    },
    "RedirectStatus": {
      "description": "HTTP status code for redirects",
      "type": "integer",
      "enum": [
        301,
        302,
        303,
        307,
        308
      ]
    },
    "RouteSpread": {
      "description": "A spread configuration for multi-variant routes\nhttps://stencila.io/docs/config/site#routes-spread",
      "type": "object",
      "properties": {
        "file": {
          "description": "The source file for this spread route\n\nPath relative to the workspace directory (or `site.root` if configured).",
          "type": "string"
        },
        "spread": {
          "description": "Spread mode\n\n- `grid`: Cartesian product of all parameter values (default)\n- `zip`: Positional pairing of values (all params must have same length)",
          "anyOf": [
            {
              "$ref": "#/definitions/SpreadMode"
            },
            {
              "type": "null"
            }
          ]
        },
        "arguments": {
          "description": "Parameter values for spread variants\n\nKeys are parameter names, values are arrays of possible values.\nExample: `{ region = [\"north\", \"south\"], species = [\"A\", \"B\"] }`",
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "required": [
        "file",
        "arguments"
      ]
    },
    "SpreadMode": {
      "description": "Spread mode for multi-variant execution",
      "oneOf": [
        {
          "description": "Cartesian product of all arguments (default)",
          "type": "string",
          "const": "grid"
        },
        {
          "description": "Positional pairing of values (all params must have same length)",
          "type": "string",
          "const": "zip"
        }
      ]
    },
    "RemoteValue": {
      "description": "Value for a remote configuration entry - can be single or multiple targets\nhttps://stencila.io/docs/config/remotes",
      "anyOf": [
        {
          "description": "Multiple remote targets for the same path\n\nExample in TOML:\n```toml\n[remotes]\n\"article.md\" = [\n  { url = \"https://docs.google.com/...\", watch = \"w456\" },\n  \"https://sharepoint.com/...\"\n]\n```",
          "type": "array",
          "items": {
            "$ref": "#/definitions/RemoteTarget"
          }
        },
        {
          "description": "Single remote target\n\nExample in TOML:\n```toml\n[remotes]\n\"site\" = \"https://example.stencila.site/\"\n\"file.md\" = { url = \"https://...\", watch = \"w123\" }\n```",
          "allOf": [
            {
              "$ref": "#/definitions/RemoteTarget"
            }
          ]
        }
      ]
    },
    "RemoteTarget": {
      "description": "A remote synchronization target\nhttps://stencila.io/docs/config/remotes",
      "anyOf": [
        {
          "description": "Simple URL string (no watch)\n\nExample: `\"https://example.stencila.site/\"`",
          "type": "string",
          "format": "uri"
        },
        {
          "description": "URL with watch information\n\nExample: `{ url = \"https://...\", watch = \"w123\" }`",
          "allOf": [
            {
              "$ref": "#/definitions/RemoteWatch"
            }
          ]
        },
        {
          "description": "Spread configuration for multi-variant pushes\n\nExample: `{ service = \"gdoc\", title = \"Report {region}\", arguments = { region = [\"north\", \"south\"] } }`",
          "allOf": [
            {
              "$ref": "#/definitions/RemoteSpread"
            }
          ]
        }
      ]
    },
    "RemoteWatch": {
      "description": "Remote synchronization information with watch ID\nhttps://stencila.io/docs/config/remotes#watch",
      "type": "object",
      "properties": {
        "url": {
          "description": "Remote URL\n\nThe service type is inferred from the URL host:\n- Google Docs: https://docs.google.com/document/d/...\n- Microsoft 365: https://*.sharepoint.com/...\n- Stencila Sites: https://*.stencila.site/...",
          "type": "string",
          "format": "uri"
        },
        "watch": {
          "description": "Watch ID from Stencila Cloud\n\nIf this remote is being watched for automatic synchronization, this\nfield contains the watch ID. Watch configuration (direction, PR mode,\ndebounce) is stored in Stencila Cloud and queried via the API.",
          "type": [
            "string",
            "null"
          ],
          "pattern": "^wa[a-z0-9]{10}$"
        }
      },
      "required": [
        "url"
      ]
    },
    "RemoteSpread": {
      "description": "Spread configuration for multi-variant pushes\nhttps://stencila.io/docs/config/remotes#spread",
      "type": "object",
      "properties": {
        "service": {
          "description": "Target service\n\nOne of: \"gdoc\", \"m365\"",
          "type": "string"
        },
        "title": {
          "description": "Title template with placeholders\n\nPlaceholders like `{param}` are replaced with arguments.\nExample: \"Report - {region}\"",
          "type": [
            "string",
            "null"
          ]
        },
        "spread": {
          "description": "Spread mode\n\n- `grid`: Cartesian product of all arguments (default)\n- `zip`: Positional pairing of values (all params must have same length)",
          "anyOf": [
            {
              "$ref": "#/definitions/SpreadMode"
            },
            {
              "type": "null"
            }
          ]
        },
        "arguments": {
          "description": "Arguments for spread variants\n\nKeys are parameter names, values are arrays of possible values.\nExample: `{ region = [\"north\", \"south\"], species = [\"A\", \"B\"] }`",
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "required": [
        "service",
        "arguments"
      ]
    },
    "OutputTarget": {
      "description": "Target for an output - either a simple source path or a full configuration\n\nOutputs define files to be rendered/converted and uploaded to Stencila Cloud\nworkspace outputs. The key is the output path template.\n\nExample in TOML:\n```toml\n[outputs]\n# Simple: source path (rendered if extension differs)\n\"report.pdf\" = \"report.md\"\n\n# Full config with options\n\"report.docx\" = { source = \"report.md\", command = \"render\" }\n\n# Static file (omit source = use key as source)\n\"data/results.csv\" = {}\n\n# Pattern for multiple files\n\"exports/*.csv\" = { pattern = \"exports/*.csv\" }\n\n# Spread with parameters\n\"{region}/report.pdf\" = { source = \"report.md\", arguments = { region = [\"north\", \"south\"] } }\n```",
      "anyOf": [
        {
          "description": "Simple source path (rendered if extension differs from key)\n\nExample: `\"report.pdf\" = \"report.md\"`",
          "allOf": [
            {
              "$ref": "#/definitions/ConfigRelativePath"
            }
          ]
        },
        {
          "description": "Full configuration object\n\nExample: `\"report.pdf\" = { source = \"report.md\", command = \"render\" }`\nExample: `\"data.csv\" = {}` (static, source = output path)",
          "allOf": [
            {
              "$ref": "#/definitions/OutputConfig"
            }
          ]
        }
      ]
    },
    "OutputConfig": {
      "description": "Full output configuration\n\nProvides detailed control over how an output is processed and uploaded.\n\nExample:\n```toml\n[outputs]\n\"report.pdf\" = { source = \"report.md\", command = \"render\" }\n\"{region}/report.pdf\" = { source = \"report.md\", arguments = { region = [\"north\", \"south\"] } }\n\"exports/*.csv\" = { pattern = \"exports/*.csv\", exclude = [\"temp-*.csv\"] }\n```",
      "type": "object",
      "properties": {
        "source": {
          "description": "Source file path (for single-file outputs)\n\nPath relative to the config file. If not specified and `pattern` is not set,\nthe output key is used as the source path.",
          "type": [
            "string",
            "null"
          ]
        },
        "pattern": {
          "description": "Glob pattern for matching multiple source files\n\nMutually exclusive with `source`. The output key must include `*.ext`\nto specify the output format (e.g., `\"reports/*.pdf\"`).",
          "type": [
            "string",
            "null"
          ]
        },
        "command": {
          "description": "Processing command\n\n- `render`: Execute code, apply parameters, convert to output format (default if extensions differ)\n- `convert`: Format transformation only, no code execution\n- `none`: Copy file as-is (default if extensions are the same)",
          "anyOf": [
            {
              "$ref": "#/definitions/OutputCommand"
            },
            {
              "type": "null"
            }
          ]
        },
        "spread": {
          "description": "Spread mode for parameter variants\n\nOnly valid with `command = render`.\n- `grid`: Cartesian product of all arguments (default)\n- `zip`: Positional pairing of values",
          "anyOf": [
            {
              "$ref": "#/definitions/SpreadMode"
            },
            {
              "type": "null"
            }
          ]
        },
        "arguments": {
          "description": "Parameter values for spread variants\n\nOnly valid with `command = render`. Keys are parameter names,\nvalues are arrays of possible values.\n\nExample: `{ region = [\"north\", \"south\"], species = [\"A\", \"B\"] }`",
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "refs": {
          "description": "Git ref patterns to filter when this output is processed and uploaded\n\nIf set, the output is only processed when the current git ref matches\none of these patterns. Supports glob matching.\n\nExamples: `[\"main\"]`, `[\"release/*\"]`, `[\"v*\"]`",
          "type": [
            "array",
            "null"
          ],
          "items": {
            "type": "string"
          }
        },
        "exclude": {
          "description": "Glob patterns to exclude from pattern matches\n\nPaths are relative to the repository root.\nOnly applies when `pattern` is set.\n\nExample: `[\"temp-*.csv\", \"draft-*\"]`",
          "type": [
            "array",
            "null"
          ],
          "items": {
            "type": "string"
          }
        }
      }
    },
    "OutputCommand": {
      "description": "Processing command for outputs\n\nDetermines how source files are processed before upload:\n- `render`: Execute code, apply parameters, then convert to output format\n- `convert`: Pure format transformation (no code execution)\n- `none`: Copy file as-is (static upload)",
      "oneOf": [
        {
          "description": "Execute code and convert to output format (default for different extensions)",
          "type": "string",
          "const": "render"
        },
        {
          "description": "Format transformation only, no code execution",
          "type": "string",
          "const": "convert"
        },
        {
          "description": "Copy file as-is (default for same extensions)",
          "type": "string",
          "const": "none"
        }
      ]
    }
  },
  "$id": "https://stencila.org/stencila-config.schema.json"
}