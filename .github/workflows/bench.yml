# Workflow for checking for regressions in performance

name: Bench

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

env:
  RUST_VERSION: "1.71.0"
  CARGO_TERM_COLOR: always
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  bench:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Poetry
        uses: snok/install-poetry@v1

      - name: Install dependencies
        run: make install

      - name: Run and collate benchmarks
        run: make bench

      - name: Pull branch before commit
        if: github.ref == 'refs/heads/main'
        run: git pull origin main

      - name: Commit benchmark data
        if: github.ref == 'refs/heads/main'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(*): Update benchmark data"

      - name: Trigger pages workflow
        run: gh workflow run pages.yml
