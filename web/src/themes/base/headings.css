/* Heading styles
 *
 * Schema: [Heading](../../schema/Heading.yaml)
 * Purpose: Document headings with hierarchical levels (h1-h6).
 *
 * DOM Structure:
 * <stencila-heading id=xxx depth=N ancestors=Parent level=1>
 *     <h1 slot=content>
 *         <stencila-text id=xxx depth=N+1 ancestors=Parent.Heading>Heading text</stencila-text>
 *     </h1>
 * </stencila-heading>
 *
 * Key Attributes:
 * - level: Heading level (1-6) determining which HTML heading element is used
 *
 * Slots:
 * - content: Contains the HTML heading element (h1-h6) with text content
 *
 * Notes:
 * - Heading levels automatically map to appropriate HTML elements (h1-h6)
 *
 * Examples: examples/conversion/heading/heading.dom.html
 */

:root {
    --heading-spacing-top: calc(var(--content-spacing) * 1.5);
    --heading-spacing-bottom: calc(var(--content-spacing) * 0.5);
    --heading-spacing-ratio: 0.8;
    --heading-spacing-adjacent-ratio: 0.5;

    /* Pre-calculated spacing for each level - used for normal and adjacent heading spacing */
    --heading-spacing-top-1: var(--heading-spacing-top);
    --heading-spacing-top-2: calc(var(--heading-spacing-top) * var(--heading-spacing-ratio));
    --heading-spacing-top-3: calc(var(--heading-spacing-top) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio));
    --heading-spacing-top-4: calc(var(--heading-spacing-top) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio));
    --heading-spacing-top-5: calc(var(--heading-spacing-top) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio));
    --heading-spacing-top-6: calc(var(--heading-spacing-top) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio));

    --heading-font-family: var(--font-family-serif);

    /* Heading size system: base size for h1, ratio for subsequent levels
     * Each level = previous level × ratio
     * With 2.0× base and 0.85 ratio: h1=2.0×, h2=1.7×, h3=1.45×, h4=1.23×, h5=1.05×, h6=0.89×
     * Ensures all headings remain at or near body text size for better hierarchy */
    --heading-font-size: calc(var(--text-font-size) * 2.0);
    --heading-font-size-print: calc(var(--text-font-size-print) * 1.75);
    --heading-font-size-ratio: 0.85;

    --heading-font-weight: var(--font-weight-bold);
    --heading-font-weight-decrement: 50;

    --heading-line-height: var(--line-height-tight);
    --heading-letter-spacing: -0.025em;

    --heading-color: var(--text-color-primary);
    --heading-color-dark: var(--text-color-primary);
    --heading-color-opacity-decrement: 0;

    /* Heading numbering: "none" (default) or "decimal" for hierarchical numbering (1., 1.1., 1.1.1., etc.) */
    --heading-numbering: none;

    /* Zone-based style helpers - convenient for applying styles to upper (h1-h3) or lower (h4-h6) heading groups */
    --heading-upper-font-style: normal;
    --heading-lower-font-style: normal;

    /* Per-level font style overrides - enables classical typography patterns like italic h4-h6 */
    --heading-h1-font-style: var(--heading-upper-font-style);
    --heading-h2-font-style: var(--heading-upper-font-style);
    --heading-h3-font-style: var(--heading-upper-font-style);
    --heading-h4-font-style: var(--heading-lower-font-style);
    --heading-h5-font-style: var(--heading-lower-font-style);
    --heading-h6-font-style: var(--heading-lower-font-style);

    /* Per-level font variant - for small-caps and other variants */
    --heading-h1-font-variant: normal;
    --heading-h2-font-variant: normal;
    --heading-h3-font-variant: normal;
    --heading-h4-font-variant: normal;
    --heading-h5-font-variant: normal;
    --heading-h6-font-variant: normal;

    /* Per-level letter-spacing overrides - larger headings often need tighter tracking */
    --heading-h1-letter-spacing: var(--heading-letter-spacing);
    --heading-h2-letter-spacing: var(--heading-letter-spacing);
    --heading-h3-letter-spacing: var(--heading-letter-spacing);
    --heading-h4-letter-spacing: var(--heading-letter-spacing);
    --heading-h5-letter-spacing: var(--heading-letter-spacing);
    --heading-h6-letter-spacing: var(--heading-letter-spacing);

    /* Per-level font-weight overrides - useful when using italic (which typically uses normal weight) */
    --heading-h1-font-weight: var(--heading-font-weight);
    --heading-h2-font-weight: calc(var(--heading-font-weight) - var(--heading-font-weight-decrement));
    --heading-h3-font-weight: calc(var(--heading-font-weight) - var(--heading-font-weight-decrement) * 2);
    --heading-h4-font-weight: calc(var(--heading-font-weight) - var(--heading-font-weight-decrement) * 3);
    --heading-h5-font-weight: calc(var(--heading-font-weight) - var(--heading-font-weight-decrement) * 4);
    --heading-h6-font-weight: calc(var(--heading-font-weight) - var(--heading-font-weight-decrement) * 5);

    /* Border system - applied to border-bottom by default (theme authors can customize for other positions)
     * Useful for bottom borders, left accent borders, or complete border boxes */
    --heading-border-width: 0;
    --heading-border-style: solid;
    --heading-border-color: var(--color-gray-300);
    --heading-border-color-dark: var(--color-gray-700);

    /* Zone-based border helpers */
    --heading-upper-border-width: var(--heading-border-width);
    --heading-upper-border-style: var(--heading-border-style);
    --heading-upper-border-color: var(--heading-border-color);
    --heading-lower-border-width: var(--heading-border-width);
    --heading-lower-border-style: var(--heading-border-style);
    --heading-lower-border-color: var(--heading-border-color);

    /* Per-level border overrides */
    --heading-h1-border-width: var(--heading-upper-border-width);
    --heading-h1-border-style: var(--heading-upper-border-style);
    --heading-h1-border-color: var(--heading-upper-border-color);
    --heading-h2-border-width: var(--heading-upper-border-width);
    --heading-h2-border-style: var(--heading-upper-border-style);
    --heading-h2-border-color: var(--heading-upper-border-color);
    --heading-h3-border-width: var(--heading-upper-border-width);
    --heading-h3-border-style: var(--heading-upper-border-style);
    --heading-h3-border-color: var(--heading-upper-border-color);
    --heading-h4-border-width: var(--heading-lower-border-width);
    --heading-h4-border-style: var(--heading-lower-border-style);
    --heading-h4-border-color: var(--heading-lower-border-color);
    --heading-h5-border-width: var(--heading-lower-border-width);
    --heading-h5-border-style: var(--heading-lower-border-style);
    --heading-h5-border-color: var(--heading-lower-border-color);
    --heading-h6-border-width: var(--heading-lower-border-width);
    --heading-h6-border-style: var(--heading-lower-border-style);
    --heading-h6-border-color: var(--heading-lower-border-color);

    /* Background colors for callout-style headings */
    --heading-background-color: transparent;
    --heading-background-color-dark: transparent;

    /* Zone-based background helpers */
    --heading-upper-background-color: var(--heading-background-color);
    --heading-lower-background-color: var(--heading-background-color);

    /* Per-level background overrides */
    --heading-h1-background-color: var(--heading-upper-background-color);
    --heading-h2-background-color: var(--heading-upper-background-color);
    --heading-h3-background-color: var(--heading-upper-background-color);
    --heading-h4-background-color: var(--heading-lower-background-color);
    --heading-h5-background-color: var(--heading-lower-background-color);
    --heading-h6-background-color: var(--heading-lower-background-color);

    /* Padding system - useful with borders and backgrounds */
    --heading-padding: 0;

    /* Zone-based padding helpers */
    --heading-upper-padding: var(--heading-padding);
    --heading-lower-padding: var(--heading-padding);

    /* Per-level padding overrides */
    --heading-h1-padding: var(--heading-upper-padding);
    --heading-h2-padding: var(--heading-upper-padding);
    --heading-h3-padding: var(--heading-upper-padding);
    --heading-h4-padding: var(--heading-lower-padding);
    --heading-h5-padding: var(--heading-lower-padding);
    --heading-h6-padding: var(--heading-lower-padding);
}

/* Spacing applied at outer element level based on heading level */
stencila-heading[level="1"] {
    margin-top: var(--heading-spacing-top-1);
}

stencila-heading[level="2"] {
    margin-top: var(--heading-spacing-top-2);
}

stencila-heading[level="3"] {
    margin-top: var(--heading-spacing-top-3);
}

stencila-heading[level="4"] {
    margin-top: var(--heading-spacing-top-4);
}

stencila-heading[level="5"] {
    margin-top: var(--heading-spacing-top-5);
}

stencila-heading[level="6"] {
    margin-top: var(--heading-spacing-top-6);
}

/* Reduced spacing for adjacent headings - avoids awkward gaps when headings follow each other */
stencila-heading+stencila-heading[level="2"] {
    margin-top: calc(var(--heading-spacing-top-2) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading+stencila-heading[level="3"] {
    margin-top: calc(var(--heading-spacing-top-3) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading+stencila-heading[level="4"] {
    margin-top: calc(var(--heading-spacing-top-4) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading+stencila-heading[level="5"] {
    margin-top: calc(var(--heading-spacing-top-5) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading+stencila-heading[level="6"] {
    margin-top: calc(var(--heading-spacing-top-6) * var(--heading-spacing-adjacent-ratio));
}

/* Reduced spacing when heading is followed by section (section's first child is typically a heading) */
stencila-heading+stencila-section>section>stencila-heading[level="2"]:first-child {
    margin-top: calc(var(--heading-spacing-top-2) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading+stencila-section>section>stencila-heading[level="3"]:first-child {
    margin-top: calc(var(--heading-spacing-top-3) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading+stencila-section>section>stencila-heading[level="4"]:first-child {
    margin-top: calc(var(--heading-spacing-top-4) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading+stencila-section>section>stencila-heading[level="5"]:first-child {
    margin-top: calc(var(--heading-spacing-top-5) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading+stencila-section>section>stencila-heading[level="6"]:first-child {
    margin-top: calc(var(--heading-spacing-top-6) * var(--heading-spacing-adjacent-ratio));
}

stencila-heading {
    display: block;

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        /* Browser normalization */
        margin-top: 0;
        overflow-wrap: break-word;

        font-family: var(--heading-font-family);
        line-height: var(--heading-line-height);
        color: var(--heading-color);
        margin-bottom: var(--heading-spacing-bottom);
    }

    h1 {
        font-size: var(--heading-font-size);
        font-weight: var(--heading-h1-font-weight);
        font-style: var(--heading-h1-font-style);
        font-variant: var(--heading-h1-font-variant);
        letter-spacing: var(--heading-h1-letter-spacing);
        border-bottom: var(--heading-h1-border-width) var(--heading-h1-border-style) var(--heading-h1-border-color);
        background-color: var(--heading-h1-background-color);
        padding: var(--heading-h1-padding);
    }

    h2 {
        font-size: calc(var(--heading-font-size) * var(--heading-font-size-ratio));
        font-weight: var(--heading-h2-font-weight);
        font-style: var(--heading-h2-font-style);
        font-variant: var(--heading-h2-font-variant);
        letter-spacing: var(--heading-h2-letter-spacing);
        margin-bottom: calc(var(--heading-spacing-bottom) * var(--heading-spacing-ratio));
        opacity: calc(1 - var(--heading-color-opacity-decrement) * 1);
        border-bottom: var(--heading-h2-border-width) var(--heading-h2-border-style) var(--heading-h2-border-color);
        background-color: var(--heading-h2-background-color);
        padding: var(--heading-h2-padding);
    }

    h3 {
        font-size: calc(var(--heading-font-size) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio));
        font-weight: var(--heading-h3-font-weight);
        font-style: var(--heading-h3-font-style);
        font-variant: var(--heading-h3-font-variant);
        letter-spacing: var(--heading-h3-letter-spacing);
        margin-bottom: calc(var(--heading-spacing-bottom) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio));
        opacity: calc(1 - var(--heading-color-opacity-decrement) * 2);
        border-bottom: var(--heading-h3-border-width) var(--heading-h3-border-style) var(--heading-h3-border-color);
        background-color: var(--heading-h3-background-color);
        padding: var(--heading-h3-padding);
    }

    h4 {
        font-size: calc(var(--heading-font-size) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio));
        font-weight: var(--heading-h4-font-weight);
        font-style: var(--heading-h4-font-style);
        font-variant: var(--heading-h4-font-variant);
        letter-spacing: var(--heading-h4-letter-spacing);
        margin-bottom: calc(var(--heading-spacing-bottom) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio));
        opacity: calc(1 - var(--heading-color-opacity-decrement) * 3);
        border-bottom: var(--heading-h4-border-width) var(--heading-h4-border-style) var(--heading-h4-border-color);
        background-color: var(--heading-h4-background-color);
        padding: var(--heading-h4-padding);
    }

    h5 {
        font-size: calc(var(--heading-font-size) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio));
        font-weight: var(--heading-h5-font-weight);
        font-style: var(--heading-h5-font-style);
        font-variant: var(--heading-h5-font-variant);
        letter-spacing: var(--heading-h5-letter-spacing);
        margin-bottom: calc(var(--heading-spacing-bottom) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio));
        opacity: calc(1 - var(--heading-color-opacity-decrement) * 4);
        border-bottom: var(--heading-h5-border-width) var(--heading-h5-border-style) var(--heading-h5-border-color);
        background-color: var(--heading-h5-background-color);
        padding: var(--heading-h5-padding);
    }

    h6 {
        font-size: calc(var(--heading-font-size) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio) * var(--heading-font-size-ratio));
        font-weight: var(--heading-h6-font-weight);
        font-style: var(--heading-h6-font-style);
        font-variant: var(--heading-h6-font-variant);
        letter-spacing: var(--heading-h6-letter-spacing);
        margin-bottom: calc(var(--heading-spacing-bottom) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio) * var(--heading-spacing-ratio));
        opacity: calc(1 - var(--heading-color-opacity-decrement) * 5);
        border-bottom: var(--heading-h6-border-width) var(--heading-h6-border-style) var(--heading-h6-border-color);
        background-color: var(--heading-h6-background-color);
        padding: var(--heading-h6-padding);
    }
}

/* Dark Mode Application - System Preference */
@media (prefers-color-scheme: dark) {
    :root:not([data-color-scheme="light"]) {
        --heading-color: var(--heading-color-dark);
        --heading-border-color: var(--heading-border-color-dark);
        --heading-background-color: var(--heading-background-color-dark);
    }
}

/* Dark Mode Application - Explicit User Choice */
:root[data-color-scheme="dark"] {
    --heading-color: var(--heading-color-dark);
    --heading-border-color: var(--heading-border-color-dark);
    --heading-background-color: var(--heading-background-color-dark);
}

/* Mobile breakpoint (640px) - Special case for h1 top margin
 * Override from automatic 1.5rem (calc(1rem * 1.5)) to 1rem for better mobile spacing
 * This deviation from automatic scaling is needed because h1's large size creates too much
 * visual weight and negative space on mobile screens. The fixed 1rem provides better
 * visual balance while maintaining content rhythm. */
@media (max-width: 640px) {
    stencila-heading[level="1"] {
        margin-top: var(--space-4);
    }
}

/* Print Application */
@media print {
    :root {
        --heading-font-size: var(--heading-font-size-print);
    }

    stencila-heading {
        /* Avoid headings from being orphaned at the bottom of pages */
        page-break-after: avoid;
        break-after: avoid-page;
    }

    stencila-heading h1,
    stencila-heading h2,
    stencila-heading h3,
    stencila-heading h4,
    stencila-heading h5,
    stencila-heading h6 {
        /* Additional specificity for the actual h1-h6 elements */
        page-break-after: avoid;
        break-after: avoid-page;
    }
    
    stencila-heading + stencila-paragraph {
        /* Avoid paragraphs from being orphaned at the top of pages */
        page-break-before: avoid;
        break-before: avoid-page;
    }
}

/* Heading numbering using CSS counters
 * Activated when data-heading-numbering="decimal" is set on an ancestor (typically <html>)
 * Produces hierarchical numbering: 1., 1.1., 1.1.1., etc.
 */
[data-heading-numbering="decimal"] {
    counter-reset: h1counter h2counter h3counter h4counter h5counter h6counter;
}

[data-heading-numbering="decimal"] stencila-heading[level="1"] {
    counter-reset: h2counter h3counter h4counter h5counter h6counter;
}

[data-heading-numbering="decimal"] stencila-heading[level="1"] h1::before {
    counter-increment: h1counter;
    content: counter(h1counter) ". ";
}

[data-heading-numbering="decimal"] stencila-heading[level="2"] {
    counter-reset: h3counter h4counter h5counter h6counter;
}

[data-heading-numbering="decimal"] stencila-heading[level="2"] h2::before {
    counter-increment: h2counter;
    content: counter(h1counter) "." counter(h2counter) ". ";
}

[data-heading-numbering="decimal"] stencila-heading[level="3"] {
    counter-reset: h4counter h5counter h6counter;
}

[data-heading-numbering="decimal"] stencila-heading[level="3"] h3::before {
    counter-increment: h3counter;
    content: counter(h1counter) "." counter(h2counter) "." counter(h3counter) ". ";
}

[data-heading-numbering="decimal"] stencila-heading[level="4"] {
    counter-reset: h5counter h6counter;
}

[data-heading-numbering="decimal"] stencila-heading[level="4"] h4::before {
    counter-increment: h4counter;
    content: counter(h1counter) "." counter(h2counter) "." counter(h3counter) "." counter(h4counter) ". ";
}

[data-heading-numbering="decimal"] stencila-heading[level="5"] {
    counter-reset: h6counter;
}

[data-heading-numbering="decimal"] stencila-heading[level="5"] h5::before {
    counter-increment: h5counter;
    content: counter(h1counter) "." counter(h2counter) "." counter(h3counter) "." counter(h4counter) "." counter(h5counter) ". ";
}

[data-heading-numbering="decimal"] stencila-heading[level="6"] h6::before {
    counter-increment: h6counter;
    content: counter(h1counter) "." counter(h2counter) "." counter(h3counter) "." counter(h4counter) "." counter(h5counter) "." counter(h6counter) ". ";
}